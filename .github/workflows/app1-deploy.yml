name: Deploy Azure Function

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Debug Subscription
      run: |
        echo "Active Azure Subscription:"
        az account show -o table

    - name: Deploy Azure Resources
      run: |
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        echo "Using Subscription ID: $SUBSCRIPTION_ID"

        RG="MyFunctionRG"
        LOCATION="eastus"
        STORAGE="myapp1store2024"
        FUNCAPP="myfunc2024app"

        az group create -n $RG -l $LOCATION

        az storage account create \
          -g $RG \
          -n $STORAGE \
          -l $LOCATION \
          --sku Standard_LRS

        az functionapp create \
          --resource-group $RG \
          --name $FUNCAPP \
          --storage-account $STORAGE \
          --consumption-plan-location $LOCATION \
          --runtime python \
          --functions-version 4

    - name: Deploy to Function App
      uses: Azure/functions-action@v1
      with:
        app-name: myfunc2024app
        package: '.'

