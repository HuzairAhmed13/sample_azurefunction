name: Deploy App1 (OIDC)

on:
  push:
    branches: ["main"]
    paths:
      - 'apps/MyAzureFunction/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_FUNCTIONAPP_NAME: 'my-unique-app1-func-2024'
  RESOURCE_GROUP_NAME: 'MyFunctionRG'
  STORAGE_ACCOUNT_NAME: 'myapp1store2024'
  LOCATION: 'eastus'
  DOTNET_VERSION: '8.0.x'
  APP_PACKAGE_PATH: 'apps/MyAzureFunction'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Azure Resources Exist
        shell: bash
        run: |
          # Capture the Subscription ID from the secret
          SUB_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          
          # Variables
          RG="${{ env.RESOURCE_GROUP_NAME }}"
          SA="${{ env.STORAGE_ACCOUNT_NAME }}"
          FUNC="${{ env.AZURE_FUNCTIONAPP_NAME }}"
          LOC="${{ env.LOCATION }}"

          echo "Using Subscription: $SUB_ID"

          # 1. Resource Group
          # We force --subscription to ensure context is never lost
          echo "Ensuring RG: $RG"
          az group create --name $RG --location $LOC --subscription "$SUB_ID"

          # 2. Storage Account
          echo "Checking Storage: $SA"
          # Check using the explicit subscription
          if ! az storage account show --name $SA --resource-group $RG --subscription "$SUB_ID" > /dev/null 2>&1; then
            echo "Creating Storage..."
            az storage account create --name $SA --resource-group $RG --location $LOC --sku Standard_LRS --subscription "$SUB_ID"
            
            # Wait 10s for Azure to propagate DNS (Prevents "Not Found" errors in next step)
            sleep 10
          fi

          # 3. Function App
          echo "Checking Function: $FUNC"
          if ! az functionapp show --name $FUNC --resource-group $RG --subscription "$SUB_ID" > /dev/null 2>&1; then
            echo "Creating Function App..."
            az functionapp create --name $FUNC \
              --storage-account $SA \
              --consumption-plan-location $LOC \
              --resource-group $RG \
              --os-type Windows \
              --runtime dotnet-isolated \
              --functions-version 4 \
              --subscription "$SUB_ID"
          fi

      - name: Setup DotNet
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build Code
        shell: bash
        run: |
          pushd './${{ env.APP_PACKAGE_PATH }}'
          dotnet build --configuration Release --output ./output
          popd

      - name: Deploy to Azure
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: '${{ env.APP_PACKAGE_PATH }}/output'
